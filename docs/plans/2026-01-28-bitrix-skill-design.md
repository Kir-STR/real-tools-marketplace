# Bitrix Skill Design

## Overview

Skill для разработки на Bitrix Framework с использованием локального индекса документации `docs/llms-bitrix.md`. Включает субагент для автоматического обновления индекса.

**Skill Name**: `bitrix` (вызов `/bitrix` или автоматически)

**Purpose**: Контекстная помощь при разработке на Bitrix с использованием актуальной документации из локального индекса.

## Архитектура

```
skills/
└── bitrix.md         # Skill + инструкции для субагента
docs/
└── llms-bitrix.md    # Индекс документации (уже существует)
```

### Стартовый flow

```
┌─────────────────────────────────────┐
│  Обнаружен Bitrix-проект            │
│  или вызван /bitrix                 │
└──────────────┬──────────────────────┘
               ▼
┌─────────────────────────────────────┐
│  Читает docs/llms-bitrix.md         │
└──────────────┬──────────────────────┘
               ▼
┌─────────────────────────────────────┐
│  "Хотите обновить индекс            │
│   документации?"                    │
│   [Да] [Нет, продолжить работу]     │
└──────────────┬──────────────────────┘
               ▼
       ┌───────┴───────┐
       │               │
      Да              Нет
       │               │
       ▼               ▼
┌─────────────┐  ┌─────────────────┐
│  Субагент   │  │  Обычная работа │
│  обновления │  │  с контекстом   │
│  индекса    │  │  из индекса     │
└─────────────┘  └─────────────────┘
```

## Skill `bitrix` — режим работы

### Автоматическая активация

- Проверяет наличие `/local/` или `/bitrix/` в корне проекта
- Если найдено — skill применяется автоматически

### При активации

1. Читает `docs/llms-bitrix.md` целиком
2. Держит в контексте как справочник
3. Предлагает обновить индекс (опционально)

### Генерация кода

- Использует D7 API вместо старого ядра (если возможно)
- Размещает кастомизации в `/local/`
- Добавляет `B_PROLOG_INCLUDED` проверку
- Применяет кэширование где уместно
- Следует best practices из индекса

### Примеры применения контекста

| Задача | Действие skill'а |
|--------|------------------|
| "Получи элементы инфоблока" | Использует ORM D7 (`Bitrix\Iblock\Elements`), не `CIBlockElement::GetList` |
| "Создай компонент" | Структура в `/local/components/`, class.php с `CBitrixComponent` |
| "Добавь обработчик события" | Регистрация в `/local/php_interface/init.php` через `EventManager` |

## Субагент обновления индекса

### Запуск

Через `Task` tool с `subagent_type: "general-purpose"`

### Автоматический процесс

```
┌────────────────────────────────────────┐
│  1. Проверка существующих ссылок       │
│     - WebFetch каждой ссылки           │
│     - Пометка битых для удаления       │
└──────────────┬─────────────────────────┘
               ▼
┌──────────────────────────────────────────────┐
│  2. Сканирование ключевых порталов           │
│     - docs.1c-bitrix.ru                      │
│     - dev.1c-bitrix.ru/api_d7/               │
│     - dev.1c-bitrix.ru/api_help/             │
│     - dev.1c-bitrix.ru/user_help/            │
│     - dev.1c-bitrix.ru/rest_help/            │
│     - dev.1c-bitrix.ru/learning/             │
│     - github.com/bitrix-tools/framework-docs │
└──────────────┬───────────────────────────────┘
               ▼
┌────────────────────────────────────────┐
│  3. Сравнение с индексом               │
│     - Найти новые разделы/статьи       │
│     - Определить секцию для каждой     │
└──────────────┬─────────────────────────┘
               ▼
┌────────────────────────────────────────┐
│  4. Отчёт пользователю                 │
│     "Найдено:                          │
│      - 2 битые ссылки                  │
│      - 5 новых статей                  │
│     Применить изменения?"              │
│     [Да, все] [Выбрать] [Отмена]       │
└──────────────┬─────────────────────────┘
               ▼
┌────────────────────────────────────────┐
│  5. Edit файла docs/llms-bitrix.md     │
└────────────────────────────────────────┘
```

### Ключевые порталы

Из секции "Основные порталы документации" в индексе:

- `docs.1c-bitrix.ru` — новый портал
- `dev.1c-bitrix.ru/api_d7/` — D7 API
- `dev.1c-bitrix.ru/api_help/` — старое ядро
- `dev.1c-bitrix.ru/learning/` — учебные курсы

## Детали реализации

### Метаданные skill'а

```yaml
name: bitrix
description: Bitrix Framework разработка с использованием локального индекса документации. Автоматически активируется при обнаружении /local/ или /bitrix/ в проекте.
```

### Структура skill'а

1. **Проверка проекта** — Glob на `/local/` или `/bitrix/`
2. **Чтение индекса** — Read `docs/llms-bitrix.md`
3. **Вопрос об обновлении** — AskUserQuestion
4. **Если "Да"** — Task субагент с инструкциями проверки/сканирования
5. **Best practices** — Инструкции по генерации кода на основе индекса

### Ограничения субагента

- Максимум 10 WebFetch запросов за сессию (чтобы не перегружать)
- Проверять только первый уровень навигации порталов
- Таймаут 30 секунд на проверку одной ссылки

### Обработка ошибок

- Битая ссылка → предложить удалить или пометить `[!]`
- Портал недоступен → пропустить, сообщить пользователю
- Нет `docs/llms-bitrix.md` → предложить создать из шаблона

## Формат записи в индексе

```markdown
- [Название](URL): Краткое описание на русском
```
